<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaft Configurator</title>
    <style>
        /* Minimal styling for floating header and basic controls */
        #price-header {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 999999;
            padding: 15px 20px;
            border-bottom: 3px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #price-display {
            font-size: 24px;
            font-weight: bold;
            color: #2B5B7F;
            position: relative;
        }
        
        #leadtime-display {
            font-size: 16px;
            font-weight: 600;
            position: relative;
        }
        
        .price-change-indicator {
            position: absolute;
            top: 100%;
            left: 0;
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
            animation: fadeInOut 3s ease-in-out;
            pointer-events: none;
        }
        
        .price-increase {
            color: #27ae60;
        }
        
        .price-decrease {
            color: #e74c3c;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(5px); }
        }
        
        .header-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #quantity {
            width: 60px;
            padding: 8px;
            border: 2px solid #333;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #add-to-cart {
            padding: 10px 20px;
            background: #E67E22;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #add-to-cart:hover {
            background: #D35400;
        }
        
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        /* Layout container for controls and preview */
        .main-layout {
            display: flex;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .controls-section {
            flex: 0 0 auto;
            width: 375px;
            max-width: 375px;
            min-width: 375px;
            overflow-x: hidden;
            padding: 12px;
            box-sizing: border-box;
        }
        
        .preview-section {
            flex: 1;
            position: sticky;
            top: 100px;
            height: fit-content;
            display: none;
        }
        
        .preview-pane {
            background: #f5f5f5;
            border: 2px solid #333;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        .preview-front {
            min-height: 400px;
        }
        
        .preview-ends {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .preview-end {
            background: #f5f5f5;
            border: 2px solid #333;
            border-radius: 4px;
            padding: 20px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        /* Show preview on larger screens */
        @media (min-width: 1024px) {
            .preview-section {
                display: block;
            }
        }
        
        /* Toggle switch styling */
        .toggle-container {
            display: flex;
            gap: 4px;
            border: 2px solid #333;
            border-radius: 4px;
            overflow: hidden;
            width: 100%;
        }
        
        .toggle-option {
            padding: 8px 16px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        .toggle-option.active {
            background: #2B5B7F;
            color: white;
        }
        
        .toggle-option:hover:not(.active) {
            background: #f0f0f0;
        }
        
        /* Button styling */
        button {
            padding: 8px 16px;
            border: 2px solid #333;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #f0f0f0;
        }
        
        /* Summary styling */
        summary {
            font-weight: bold;
            font-size: 15px;
            cursor: pointer;
            padding: 10px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            margin-bottom: 8px;
            list-style: none;
            position: relative;
            padding-left: 28px;
        }
        
        summary::-webkit-details-marker {
            display: none;
        }
        
        summary::before {
            content: 'â–¼';
            position: absolute;
            left: 8px;
            transition: transform 0.2s;
        }
        
        details[open] summary::before {
            transform: rotate(180deg);
        }
        
        summary:hover {
            background: #e8e8e8;
        }
        
        details > div {
            padding: 0;
            margin-bottom: 12px;
        }
        
        h4 {
            margin-top: 12px;
            margin-bottom: 6px;
            color: #2B5B7F;
            font-size: 14px;
        }
        
        .advanced-features {
            border-left: 3px solid #E67E22;
            padding-left: 10px;
            margin-top: 10px;
        }
        
        * {
            box-sizing: border-box;
        }
        
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            font-size: 14px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        label {
            font-size: 14px;
        }
        
        p {
            font-size: 14px;
            margin: 6px 0;
        }
        
        /* Custom number input with orange split buttons */
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .number-input-wrapper {
            display: inline-flex;
            align-items: stretch;
            gap: 0;
            max-width: 130px;
        }
        
        .number-input-wrapper input[type="number"] {
            width: 70px;
            min-width: 0;
            border-radius: 0;
            border-left: none;
            border-right: none;
            text-align: center;
        }
        
        .number-input-buttons {
            display: flex;
            flex-direction: row;
        }
        
        .number-input-buttons button {
            width: 30px;
            border: none;
            background: #E67E22;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .number-input-buttons:first-child button {
            border-radius: 3px 0 0 3px;
        }
        
        .number-input-buttons:last-child button {
            border-radius: 0 3px 3px 0;
        }
        
        .number-input-buttons button:hover {
            background: #D35400;
        }
        
        .number-input-buttons button:active {
            background: #BA4A00;
        }
        
        .spinbox-row {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        
        .spinbox-row > div {
            flex: 1;
        }
        
        /* Corner condition radio cards */
        .corner-cards {
            display: flex;
            gap: 3px;
            flex-wrap: nowrap;
            width: 100%;
        }
        
        .corner-card {
            flex: 1 1 0;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 2px;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .corner-card:hover {
            border-color: #2B5B7F;
            background: #f8f9fa;
        }
        
        .corner-card input[type="radio"] {
            display: none;
        }
        
        .corner-card input[type="radio"]:checked + .corner-graphic {
            background: #E8F4F8;
            border-radius: 3px;
        }
        
        .corner-card input[type="radio"]:checked ~ .corner-label {
            color: #2B5B7F;
            font-weight: bold;
        }
        
        .corner-card:has(input[type="radio"]:checked) {
            border-color: #2B5B7F;
            background: #E8F4F8;
        }
        
        .corner-graphic {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2px;
            width: 100%;
        }
        
        .corner-graphic svg {
            width: 32px;
            height: 32px;
            display: block;
        }
        
        .corner-label {
            font-size: 10px;
            text-align: center;
            color: #333;
            line-height: 1.2;
        }
        
        .corner-detail-controls {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 3px;
            display: none;
        }
        
        .corner-detail-controls label {
            display: block;
            margin-bottom: 4px;
            font-size: 13px;
        }
        
        .corner-detail-controls select {
            width: 100%;
        }
        
        /* iOS-style toggle switches */
        .ios-toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .ios-toggle-label {
            font-size: 14px;
            color: #333;
            flex: 1;
            padding-right: 10px;
        }
        
        .ios-toggle {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 26px;
            flex-shrink: 0;
        }
        
        .ios-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .ios-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        
        .ios-toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        .ios-toggle input:checked + .ios-toggle-slider {
            background-color: #E67E22;
        }
        
        .ios-toggle input:checked + .ios-toggle-slider:before {
            transform: translateX(20px);
        }
        
        #initial-journal-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        
        #initial-journal-buttons button {
            width: 100%;
        }
        
        hr {
            margin: 10px 0;
            border: none;
            border-top: 1px solid #ddd;
        }
        
        /* ========== MOBILE STYLES ========== */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }
            
            #price-header {
                flex-wrap: wrap;
                gap: 8px;
                padding: 10px;
            }
            
            #price-display {
                font-size: 18px;
            }
            
            #leadtime-display {
                font-size: 14px;
            }
            
            .main-layout {
                padding: 0;
                margin: 0;
                gap: 0;
            }
            
            .controls-section {
                width: 100%;
                max-width: 100%;
                min-width: 0;
                padding: 8px;
            }
            
            details > div {
                padding: 0;
                margin-bottom: 10px;
            }
            
            summary {
                padding: 8px;
                padding-left: 26px;
                font-size: 14px;
                margin-bottom: 6px;
            }
            
            summary::before {
                left: 6px;
                font-size: 12px;
            }
            
            h4 {
                font-size: 13px;
                margin-top: 8px;
                margin-bottom: 4px;
            }
            
            p {
                font-size: 13px;
                margin: 4px 0;
                word-wrap: break-word;
            }
            
            .corner-cards {
                gap: 2px;
            }
            
            .corner-card {
                padding: 3px 1px;
                border-width: 1px;
            }
            
            .corner-graphic svg {
                width: 26px;
                height: 26px;
            }
            
            .corner-label {
                font-size: 9px;
            }
            
            input[type="number"],
            input[type="text"],
            select {
                font-size: 13px;
                padding: 5px;
            }
            
            .number-input-wrapper {
                max-width: 110px;
            }
            
            .number-input-wrapper input[type="number"] {
                width: 55px;
                font-size: 13px;
            }
            
            .number-input-buttons button {
                width: 27px;
                font-size: 13px;
            }
            
            .toggle-container {
                gap: 2px;
                border-width: 1px;
            }
            
            .toggle-option {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .ios-toggle {
                width: 42px;
                height: 24px;
            }
            
            .ios-toggle-slider:before {
                height: 20px;
                width: 20px;
            }
            
            .ios-toggle input:checked + .ios-toggle-slider:before {
                transform: translateX(18px);
            }
            
            .ios-toggle-row {
                padding: 6px 0;
            }
            
            .corner-detail-controls {
                margin-top: 6px;
                padding: 6px;
            }
            
            .corner-detail-controls label {
                font-size: 12px;
                margin-bottom: 3px;
            }
            
            button {
                padding: 7px 12px;
                font-size: 13px;
                border-width: 1px;
            }
            
            #initial-journal-buttons {
                margin-top: 8px;
                gap: 6px;
            }
            
            .advanced-features {
                padding-left: 8px;
                margin-top: 8px;
            }
            
            hr {
                margin: 8px 0;
            }
            
            strong, em {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
        }
        
        .controls-section * {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <!-- Floating Price/Lead Time/Quantity Header -->
    <div id="price-header">
        <div id="price-display">$125.00</div>
        <div id="leadtime-display">Ships: Mon, Nov 4 (5 days)</div>
        <div class="header-group">
            <label for="quantity">Qty:</label>
            <div class="number-input-wrapper">
                <div class="number-input-buttons">
                    <button type="button" onclick="adjustValue('quantity', -1)">-</button>
                </div>
                <input type="number" id="quantity" value="1" min="1" max="1000" step="1">
                <div class="number-input-buttons">
                    <button type="button" onclick="adjustValue('quantity', 1)">+</button>
                </div>
            </div>
        </div>
        <button id="add-to-cart">Add to Cart</button>
    </div>
    
    <div class="main-layout">
        <div class="controls-section">
    
    <!-- Advanced Mode Toggle -->
    <div class="ios-toggle-row" style="padding: 10px 0;">
        <span class="ios-toggle-label">Advanced</span>
        <label class="ios-toggle">
            <input type="checkbox" id="advanced-mode-toggle">
            <span class="ios-toggle-slider"></span>
        </label>
    </div>
    
    <hr>
    
    <!-- General Details -->
    <details open>
        <summary>GENERAL DETAILS</summary>
        <div>
            <div class="ios-toggle-row">
                <span class="ios-toggle-label">Turned, Ground & Polished</span>
                <label class="ios-toggle">
                    <input type="checkbox" id="finish-tgp-toggle">
                    <span class="ios-toggle-slider"></span>
                </label>
            </div>
            
            <h4>Material</h4>
            <select id="material-select">
                <option value="1018">1018 Cold Rolled Steel</option>
                <option value="1045">1045 Medium Carbon Steel</option>
                <option value="4140">4140 Alloy Steel</option>
                <option value="303">303 Stainless Steel</option>
                <option value="304">304 Stainless Steel</option>
                <option value="316">316 Stainless Steel</option>
            </select>
            
            <h4>Tolerance</h4>
            <p><em>Standard: Â±0.005"</em></p>
            
            <h4>Global Corner Conditions</h4>
            <p><strong>Inside Corners:</strong></p>
            <div class="corner-cards">
                <label class="corner-card">
                    <input type="radio" name="global-inside" value="sharp" checked>
                    <div class="corner-graphic">
                        <svg width="60" height="60" viewBox="0 0 60 60">
                            <line x1="37.5" y1="15" x2="37.5" y2="37.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <line x1="37.5" y1="37.5" x2="15" y2="37.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <circle cx="30" cy="30" r="2.5" fill="#E67E22"/>
                        </svg>
                    </div>
                    <div class="corner-label">Sharp</div>
                </label>
                
                <label class="corner-card">
                    <input type="radio" name="global-inside" value="chamfer">
                    <div class="corner-graphic">
                        <svg width="60" height="60" viewBox="0 0 60 60">
                            <line x1="37.5" y1="15" x2="37.5" y2="37.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <line x1="37.5" y1="37.5" x2="15" y2="37.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <polygon points="30,15 30,30 15,30" fill="#1E3A5F"/>
                            <line x1="30" y1="15" x2="15" y2="30" stroke="#E67E22" stroke-width="3"/>
                        </svg>
                    </div>
                    <div class="corner-label">Chamfer</div>
                </label>
                
                <label class="corner-card">
                    <input type="radio" name="global-inside" value="radius">
                    <div class="corner-graphic">
                        <svg width="60" height="60" viewBox="0 0 60 60">
                            <line x1="37.5" y1="15" x2="37.5" y2="37.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <line x1="37.5" y1="37.5" x2="15" y2="37.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <path d="M 30 15 L 30 30 L 15 30 Q 30 30, 30 15 Z" fill="#1E3A5F"/>
                            <path d="M 30 15 Q 30 30, 15 30" fill="none" stroke="#E67E22" stroke-width="3"/>
                        </svg>
                    </div>
                    <div class="corner-label">Radius</div>
                </label>
            </div>
            
            <div id="global-inside-chamfer-controls" class="corner-detail-controls">
                <label>Chamfer Distance: 
                    <select>
                        <option value="0.015">0.015"</option>
                        <option value="0.030" selected>0.030"</option>
                        <option value="0.045">0.045"</option>
                        <option value="0.060">0.060"</option>
                    </select>
                </label>
            </div>
            
            <div id="global-inside-radius-controls" class="corner-detail-controls">
                <label>Radius: 
                    <select>
                        <option value="0.015">0.015"</option>
                        <option value="0.030">0.030"</option>
                        <option value="0.045">0.045"</option>
                        <option value="0.060" selected>0.060"</option>
                    </select>
                </label>
            </div>
            
            <p><strong>Outside Corners:</strong></p>
            <div class="corner-cards">
                <label class="corner-card">
                    <input type="radio" name="global-outside" value="sharp" checked>
                    <div class="corner-graphic">
                        <svg width="60" height="60" viewBox="0 0 60 60">
                            <line x1="22.5" y1="45" x2="22.5" y2="22.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <line x1="22.5" y1="22.5" x2="45" y2="22.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <circle cx="15" cy="15" r="2.5" fill="#E67E22"/>
                        </svg>
                    </div>
                    <div class="corner-label">Sharp</div>
                </label>
                
                <label class="corner-card">
                    <input type="radio" name="global-outside" value="chamfer">
                    <div class="corner-graphic">
                        <svg width="60" height="60" viewBox="0 0 60 60">
                            <line x1="22.5" y1="45" x2="22.5" y2="22.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <line x1="22.5" y1="22.5" x2="45" y2="22.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <polygon points="15,15 15,30 30,15" fill="#E67E22"/>
                            <line x1="15" y1="30" x2="30" y2="15" stroke="#E67E22" stroke-width="3"/>
                        </svg>
                    </div>
                    <div class="corner-label">Chamfer</div>
                </label>
                
                <label class="corner-card">
                    <input type="radio" name="global-outside" value="radius">
                    <div class="corner-graphic">
                        <svg width="60" height="60" viewBox="0 0 60 60">
                            <line x1="22.5" y1="45" x2="22.5" y2="22.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <line x1="22.5" y1="22.5" x2="45" y2="22.5" stroke="#1E3A5F" stroke-width="15" stroke-linecap="square"/>
                            <path d="M 15 15 L 15 37.5 Q 15 15, 37.5 15 Z" fill="#E67E22"/>
                            <path d="M 15.25 37.5 Q 15.25 15.25, 37.5 15.25" fill="none" stroke="#E67E22" stroke-width="0.5"/>
                        </svg>
                    </div>
                    <div class="corner-label">Radius</div>
                </label>
            </div>
            
            <div id="global-outside-chamfer-controls" class="corner-detail-controls">
                <label>Chamfer Distance: 
                    <select>
                        <option value="0.015">0.015"</option>
                        <option value="0.030" selected>0.030"</option>
                        <option value="0.045">0.045"</option>
                        <option value="0.060">0.060"</option>
                    </select>
                </label>
            </div>
            
            <div id="global-outside-radius-controls" class="corner-detail-controls">
                <label>Radius: 
                    <select>
                        <option value="0.015">0.015"</option>
                        <option value="0.030">0.030"</option>
                        <option value="0.045">0.045"</option>
                        <option value="0.060" selected>0.060"</option>
                    </select>
                </label>
            </div>
            
            <p><em>Note: Defaults apply to all steps. Override per-step in Advanced mode.</em></p>
        </div>
    </details>
    
    <!-- Main Shaft -->
    <details open>
        <summary>MAIN SHAFT</summary>
        <div>
            <h4>Dimensions</h4>
            <p>Diameter:</p>
            <select id="main-diameter">
                <option value="0.5">1/2"</option>
                <option value="0.75">3/4"</option>
                <option value="1.0" selected>1"</option>
                <option value="1.25">1-1/4"</option>
                <option value="1.5">1-1/2"</option>
                <option value="2.0">2"</option>
            </select>
            
            <p style="margin-top: 8px;">Length (inches):</p>
            <input type="number" id="main-length" value="6" min="1" max="24" step="0.5">
            
            <div class="ios-toggle-row" style="margin-top: 8px;">
                <span class="ios-toggle-label">Left Keyway</span>
                <label class="ios-toggle">
                    <input type="checkbox" id="main-left-keyway-toggle">
                    <span class="ios-toggle-slider"></span>
                </label>
            </div>
            
            <div id="main-left-keyway-controls" style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 3px;">
                <p><strong>Configuration:</strong></p>
                <div class="toggle-container">
                    <button type="button" class="toggle-option active" data-keyway="main-left" data-config="captivated">Captivated</button>
                    <button type="button" class="toggle-option" data-keyway="main-left" data-config="end">End</button>
                </div>
                
                <p style="margin-top: 8px;"><strong>Keyway Size:</strong></p>
                <select id="main-left-keyway-size">
                    <!-- Populated dynamically based on shaft diameter -->
                </select>
                
                <p style="margin-top: 8px;"><strong>Key Depth:</strong></p>
                <p id="main-left-key-depth" style="margin: 4px 0; font-style: italic; color: #666;">-</p>
                
                <p style="margin-top: 8px;"><strong>Keyway Length:</strong></p>
                <div class="number-input-wrapper">
                    <div class="number-input-buttons">
                        <button type="button" onclick="adjustValue('main-left-keyway-length', -0.125)">-</button>
                    </div>
                    <input type="number" id="main-left-keyway-length" value="1.0" min="0.125" max="24" step="0.125">
                    <div class="number-input-buttons">
                        <button type="button" onclick="adjustValue('main-left-keyway-length', 0.125)">+</button>
                    </div>
                </div>
            </div>
            
            <div class="ios-toggle-row">
                <span class="ios-toggle-label">Right Keyway</span>
                <label class="ios-toggle">
                    <input type="checkbox" id="main-right-keyway-toggle">
                    <span class="ios-toggle-slider"></span>
                </label>
            </div>
            
            <div id="main-right-keyway-controls" style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 3px;">
                <p><strong>Configuration:</strong></p>
                <div class="toggle-container">
                    <button type="button" class="toggle-option active" data-keyway="main-right" data-config="captivated">Captivated</button>
                    <button type="button" class="toggle-option" data-keyway="main-right" data-config="end">End</button>
                </div>
                
                <p style="margin-top: 8px;"><strong>Keyway Size:</strong></p>
                <select id="main-right-keyway-size">
                    <!-- Populated dynamically based on shaft diameter -->
                </select>
                
                <p style="margin-top: 8px;"><strong>Key Depth:</strong></p>
                <p id="main-right-key-depth" style="margin: 4px 0; font-style: italic; color: #666;">-</p>
                
                <p style="margin-top: 8px;"><strong>Keyway Length:</strong></p>
                <div class="number-input-wrapper">
                    <div class="number-input-buttons">
                        <button type="button" onclick="adjustValue('main-right-keyway-length', -0.125)">-</button>
                    </div>
                    <input type="number" id="main-right-keyway-length" value="1.0" min="0.125" max="24" step="0.125">
                    <div class="number-input-buttons">
                        <button type="button" onclick="adjustValue('main-right-keyway-length', 0.125)">+</button>
                    </div>
                </div>
            </div>
        </div>
    </details>
    
    <!-- Add Journal Buttons -->
    <div id="initial-journal-buttons">
        <button type="button" class="add-journal-left">+ Add Journal LEFT</button>
        <button type="button" class="add-journal-right">+ Add Journal RIGHT</button>
    </div>
    
    <div id="journals-container"></div>
    
        </div>
        
        <!-- Preview Section -->
        <div class="preview-section">
            <div class="preview-pane preview-front">
                <div>Front View Preview</div>
            </div>
            <div class="preview-ends">
                <div class="preview-end">
                    <div>Left End View</div>
                </div>
                <div class="preview-end">
                    <div>Right End View</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // GLOBAL STATE
        // ===========================================
        let journalCounter = 0;
        const journals = {
            left: [],
            right: []
        };
        let advancedMode = false;

        // ===========================================
        // TG&P MATERIAL RESTRICTIONS
        // ===========================================
        const tgpToggle = document.getElementById('finish-tgp-toggle');
        const materialSelect = document.getElementById('material-select');
        
        // Store original selected value
        let previousMaterial = materialSelect.value;
        
        function updateMaterialOptions() {
            const isTGP = tgpToggle.checked;
            const stainlessOptions = ['303', '304', '316'];
            
            // Get all options
            Array.from(materialSelect.options).forEach(option => {
                if (stainlessOptions.includes(option.value)) {
                    if (isTGP) {
                        // Disable stainless options when TG&P is on
                        option.disabled = true;
                        option.style.color = '#999';
                        option.textContent = option.textContent.replace(' (Not available with TG&P)', '') + ' (Not available with TG&P)';
                    } else {
                        // Enable when TG&P is off
                        option.disabled = false;
                        option.style.color = '';
                        option.textContent = option.textContent.replace(' (Not available with TG&P)', '');
                    }
                }
            });
            
            // If current selection is stainless and TG&P just turned on, switch to 1018
            if (isTGP && stainlessOptions.includes(materialSelect.value)) {
                materialSelect.value = '1018';
                alert('TG&P finish is not available for stainless steel. Material changed to 1018 Cold Rolled Steel.');
            }
        }
        
        // Initialize material restrictions on load
        updateMaterialOptions();
        
        // Update when TG&P toggle changes
        tgpToggle.addEventListener('change', function() {
            updateMaterialOptions();
            updateHeight();
        });

        // ===========================================
        // ADVANCED MODE TOGGLE
        // ===========================================
        const advancedToggle = document.getElementById('advanced-mode-toggle');
        
        function updateAdvancedMode() {
            advancedMode = advancedToggle.checked;
            
            // Get all advanced feature elements
            const advancedElements = document.querySelectorAll('.advanced-features');
            
            advancedElements.forEach(el => {
                if (advancedMode) {
                    el.style.display = 'block';
                } else {
                    el.style.display = 'none';
                }
            });
            
            updateHeight();
            console.log('Advanced mode:', advancedMode);
        }
        
        advancedToggle.addEventListener('change', updateAdvancedMode);

        // ===========================================
        // KEYWAY LOOKUP TABLE (ANSI B17.1)
        // ===========================================
        function getStandardKeyway(diameter) {
            if (diameter < 0.4375) return { width: '1/16"', depth: '1/32"', widthVal: 0.0625, depthVal: 0.03125 };
            if (diameter < 0.5625) return { width: '3/32"', depth: '3/64"', widthVal: 0.09375, depthVal: 0.046875 };
            if (diameter < 0.875) return { width: '1/8"', depth: '1/16"', widthVal: 0.125, depthVal: 0.0625 };
            if (diameter < 1.25) return { width: '3/16"', depth: '3/32"', widthVal: 0.1875, depthVal: 0.09375 };
            if (diameter < 1.375) return { width: '1/4"', depth: '1/8"', widthVal: 0.25, depthVal: 0.125 };
            if (diameter < 1.75) return { width: '5/16"', depth: '5/32"', widthVal: 0.3125, depthVal: 0.15625 };
            if (diameter < 2.25) return { width: '3/8"', depth: '3/16"', widthVal: 0.375, depthVal: 0.1875 };
            if (diameter < 2.75) return { width: '1/2"', depth: '1/4"', widthVal: 0.5, depthVal: 0.25 };
            return { width: '5/8"', depth: '5/16"', widthVal: 0.625, depthVal: 0.3125 };
        }
        
        function getAllKeywayOptions(maxDiameter) {
            const allKeyways = [
                { diameter: 0.4375, width: '1/16"', depth: '1/32"', widthVal: 0.0625, depthVal: 0.03125 },
                { diameter: 0.5625, width: '3/32"', depth: '3/64"', widthVal: 0.09375, depthVal: 0.046875 },
                { diameter: 0.875, width: '1/8"', depth: '1/16"', widthVal: 0.125, depthVal: 0.0625 },
                { diameter: 1.25, width: '3/16"', depth: '3/32"', widthVal: 0.1875, depthVal: 0.09375 },
                { diameter: 1.375, width: '1/4"', depth: '1/8"', widthVal: 0.25, depthVal: 0.125 },
                { diameter: 1.75, width: '5/16"', depth: '5/32"', widthVal: 0.3125, depthVal: 0.15625 },
                { diameter: 2.25, width: '3/8"', depth: '3/16"', widthVal: 0.375, depthVal: 0.1875 },
                { diameter: 2.75, width: '1/2"', depth: '1/4"', widthVal: 0.5, depthVal: 0.25 },
                { diameter: 3.0, width: '5/8"', depth: '5/16"', widthVal: 0.625, depthVal: 0.3125 }
            ];
            
            // Return only keyways smaller than the shaft diameter
            return allKeyways.filter(k => k.widthVal < maxDiameter);
        }
        
        function populateKeywayOptions(selectId, diameter) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const options = getAllKeywayOptions(diameter);
            const standard = getStandardKeyway(diameter);
            
            select.innerHTML = '';
            
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.widthVal;
                opt.textContent = `${option.width} Ã— ${option.depth}`;
                
                // Select the standard size by default
                if (option.width === standard.width) {
                    opt.selected = true;
                }
                
                select.appendChild(opt);
            });
            
            // Update depth display
            updateKeyDepth(selectId.replace('-size', ''));
        }
        
        function updateKeyDepth(keyPrefix) {
            const select = document.getElementById(`${keyPrefix}-size`);
            const depthDisplay = document.getElementById(`${keyPrefix}-depth`);
            
            if (!select || !depthDisplay) return;
            
            const selectedWidth = parseFloat(select.value);
            const allKeyways = [
                { widthVal: 0.0625, depthVal: 0.03125, depth: '1/32"' },
                { widthVal: 0.09375, depthVal: 0.046875, depth: '3/64"' },
                { widthVal: 0.125, depthVal: 0.0625, depth: '1/16"' },
                { widthVal: 0.1875, depthVal: 0.09375, depth: '3/32"' },
                { widthVal: 0.25, depthVal: 0.125, depth: '1/8"' },
                { widthVal: 0.3125, depthVal: 0.15625, depth: '5/32"' },
                { widthVal: 0.375, depthVal: 0.1875, depth: '3/16"' },
                { widthVal: 0.5, depthVal: 0.25, depth: '1/4"' },
                { widthVal: 0.625, depthVal: 0.3125, depth: '5/16"' }
            ];
            
            const keyway = allKeyways.find(k => k.widthVal === selectedWidth);
            depthDisplay.textContent = keyway ? keyway.depth : '-';
        }

        // ===========================================
        // MAIN SHAFT KEYWAY CONTROLS
        // ===========================================
        const mainDiameterSelect = document.getElementById('main-diameter');
        const mainLeftKeywayToggle = document.getElementById('main-left-keyway-toggle');
        const mainRightKeywayToggle = document.getElementById('main-right-keyway-toggle');
        const mainLeftKeywayControls = document.getElementById('main-left-keyway-controls');
        const mainRightKeywayControls = document.getElementById('main-right-keyway-controls');
        
        // Initialize keyway options based on main diameter
        function updateMainKeywayOptions() {
            const diameter = parseFloat(mainDiameterSelect.value);
            populateKeywayOptions('main-left-keyway-size', diameter);
            populateKeywayOptions('main-right-keyway-size', diameter);
        }
        
        // Show/hide keyway controls based on toggle
        mainLeftKeywayToggle.addEventListener('change', function() {
            mainLeftKeywayControls.style.display = this.checked ? 'block' : 'none';
            if (this.checked) {
                updateMainKeywayOptions();
            }
            updateHeight();
        });
        
        mainRightKeywayToggle.addEventListener('change', function() {
            mainRightKeywayControls.style.display = this.checked ? 'block' : 'none';
            if (this.checked) {
                updateMainKeywayOptions();
            }
            updateHeight();
        });
        
        // Update keyway options when diameter changes
        mainDiameterSelect.addEventListener('change', function() {
            if (mainLeftKeywayToggle.checked) {
                updateMainKeywayOptions();
            }
            if (mainRightKeywayToggle.checked) {
                updateMainKeywayOptions();
            }
        });
        
        // Keyway size change handlers
        document.getElementById('main-left-keyway-size')?.addEventListener('change', function() {
            updateKeyDepth('main-left-keyway');
        });
        
        document.getElementById('main-right-keyway-size')?.addEventListener('change', function() {
            updateKeyDepth('main-right-keyway');
        });
        
        // Captivated/End toggle handlers
        document.querySelectorAll('[data-keyway]').forEach(button => {
            button.addEventListener('click', function() {
                const keyway = this.dataset.keyway;
                const siblings = document.querySelectorAll(`[data-keyway="${keyway}"]`);
                siblings.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Number input adjustment helper
        window.adjustValue = function(inputId, delta) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            const currentValue = parseFloat(input.value) || 0;
            const min = parseFloat(input.min) || 0;
            const max = parseFloat(input.max) || 999;
            const step = parseFloat(input.step) || 1;
            
            let newValue = currentValue + delta;
            newValue = Math.max(min, Math.min(max, newValue));
            newValue = Math.round(newValue / step) * step;
            
            input.value = newValue.toFixed(3).replace(/\.?0+$/, '');
        };

        // ===========================================
        // JOURNAL CREATION FUNCTIONS
        // ===========================================
        function createJournal(side) {
            journalCounter++;
            const journalId = `journal-${side}-${journalCounter}`;
            
            const journalHTML = `
                <details open>
                    <summary>JOURNAL ${side.toUpperCase()} #${journals[side].length + 1}</summary>
                    <div>
                        <h4>Dimensions</h4>
                        <p>Diameter:</p>
                        <select id="${journalId}-diameter">
                            <option value="0.375">3/8"</option>
                            <option value="0.5">1/2"</option>
                            <option value="0.625">5/8"</option>
                            <option value="0.75" selected>3/4"</option>
                            <option value="0.875">7/8"</option>
                            <option value="1.0">1"</option>
                        </select>
                        
                        <p style="margin-top: 8px;">Length (inches):</p>
                        <input type="number" id="${journalId}-length" value="1" min="0.25" max="12" step="0.25">
                        
                        <h4 style="margin-top: 12px;">Features</h4>
                        
                        <div class="ios-toggle-row">
                            <span class="ios-toggle-label">Keyway</span>
                            <label class="ios-toggle">
                                <input type="checkbox" id="${journalId}-keyway">
                                <span class="ios-toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div id="${journalId}-keyway-controls" style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 3px;">
                            <p><strong>Configuration:</strong></p>
                            <div class="toggle-container" style="margin-bottom: 12px;">
                                <button type="button" class="toggle-option active" data-keyway="${journalId}-keyway" data-config="captivated">Captivated</button>
                                <button type="button" class="toggle-option" data-keyway="${journalId}-keyway" data-config="end">End</button>
                            </div>
                            
                            <p><strong>Size:</strong></p>
                            <select id="${journalId}-keyway-size">
                                <!-- Populated dynamically based on shaft diameter -->
                            </select>
                            
                            <div class="advanced-features" style="display: none; margin-top: 8px;">
                                <p><strong>Clocking:</strong></p>
                                <select id="${journalId}-keyway-clocking">
                                    <option value="0" selected>0Â°</option>
                                    <option value="45">45Â°</option>
                                    <option value="90">90Â°</option>
                                    <option value="135">135Â°</option>
                                    <option value="180">180Â°</option>
                                    <option value="225">225Â°</option>
                                    <option value="270">270Â°</option>
                                    <option value="315">315Â°</option>
                                </select>
                            </div>
                            
                            <div id="${journalId}-keyway-location-controls" style="display: block; margin-top: 8px;">
                                <div class="spinbox-row">
                                    <div>
                                        <p><strong>Length:</strong></p>
                                        <div class="number-input-wrapper">
                                            <div class="number-input-buttons">
                                                <button type="button" onclick="adjustValue('${journalId}-keyway-length', -0.125)">-</button>
                                            </div>
                                            <input type="number" id="${journalId}-keyway-length" value="0.5" min="0.125" max="12" step="0.125">
                                            <div class="number-input-buttons">
                                                <button type="button" onclick="adjustValue('${journalId}-keyway-length', 0.125)">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <p><strong>Location from ${side === 'left' ? 'Left' : 'Right'} End:</strong></p>
                                        <div class="number-input-wrapper">
                                            <div class="number-input-buttons">
                                                <button type="button" onclick="adjustValue('${journalId}-keyway-location', -0.125)">-</button>
                                            </div>
                                            <input type="number" id="${journalId}-keyway-location" value="0.25" min="0" max="12" step="0.125">
                                            <div class="number-input-buttons">
                                                <button type="button" onclick="adjustValue('${journalId}-keyway-location', 0.125)">+</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ios-toggle-row">
                            <span class="ios-toggle-label">Retaining Ring</span>
                            <label class="ios-toggle">
                                <input type="checkbox" id="${journalId}-retaining-ring">
                                <span class="ios-toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div id="${journalId}-retaining-ring-controls" style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 3px;">
                            <p><strong>Diameter:</strong></p>
                            <select id="${journalId}-retaining-ring-diameter">
                                <option value="0.25">1/4"</option>
                                <option value="0.375">3/8"</option>
                                <option value="0.5">1/2"</option>
                                <option value="0.625" selected>5/8"</option>
                            </select>
                            
                            <div class="spinbox-row" style="margin-top: 8px;">
                                <div>
                                    <p><strong>Width:</strong></p>
                                    <div class="number-input-wrapper">
                                        <div class="number-input-buttons">
                                            <button type="button" onclick="adjustValue('${journalId}-retaining-ring-width', -0.0625)">-</button>
                                        </div>
                                        <input type="number" id="${journalId}-retaining-ring-width" value="0.125" min="0.0625" max="1" step="0.0625">
                                        <div class="number-input-buttons">
                                            <button type="button" onclick="adjustValue('${journalId}-retaining-ring-width', 0.0625)">+</button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <p><strong>Location from End:</strong></p>
                                    <div class="number-input-wrapper">
                                        <div class="number-input-buttons">
                                            <button type="button" onclick="adjustValue('${journalId}-retaining-ring-location', -0.125)">-</button>
                                        </div>
                                        <input type="number" id="${journalId}-retaining-ring-location" value="0.5" min="0" max="12" step="0.125">
                                        <div class="number-input-buttons">
                                            <button type="button" onclick="adjustValue('${journalId}-retaining-ring-location', 0.125)">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="advanced-features" style="display: none;">
                            <h4 style="margin-top: 12px;">Corner Condition Overrides</h4>
                            <p><strong>Inside Corners:</strong></p>
                            <select id="${journalId}-inside-corner">
                                <option value="global" selected>Use Global</option>
                                <option value="sharp">Sharp</option>
                                <option value="chamfer">Chamfer</option>
                                <option value="radius">Radius</option>
                            </select>
                            
                            <div id="${journalId}-inside-chamfer-controls" style="display: none; margin-top: 8px;">
                                <label>Chamfer Distance: 
                                    <select id="${journalId}-inside-chamfer-size">
                                        <option value="0.015">0.015"</option>
                                        <option value="0.030" selected>0.030"</option>
                                        <option value="0.045">0.045"</option>
                                        <option value="0.060">0.060"</option>
                                    </select>
                                </label>
                            </div>
                            
                            <div id="${journalId}-inside-radius-controls" style="display: none; margin-top: 8px;">
                                <label>Radius: 
                                    <select id="${journalId}-inside-radius-size">
                                        <option value="0.015">0.015"</option>
                                        <option value="0.030">0.030"</option>
                                        <option value="0.045">0.045"</option>
                                        <option value="0.060" selected>0.060"</option>
                                    </select>
                                </label>
                            </div>
                            
                            <p style="margin-top: 8px;"><strong>Outside Corners:</strong></p>
                            <select id="${journalId}-outside-corner">
                                <option value="global" selected>Use Global</option>
                                <option value="sharp">Sharp</option>
                                <option value="chamfer">Chamfer</option>
                                <option value="radius">Radius</option>
                            </select>
                            
                            <div id="${journalId}-outside-chamfer-controls" style="display: none; margin-top: 8px;">
                                <label>Chamfer Distance: 
                                    <select id="${journalId}-outside-chamfer-size">
                                        <option value="0.015">0.015"</option>
                                        <option value="0.030" selected>0.030"</option>
                                        <option value="0.045">0.045"</option>
                                        <option value="0.060">0.060"</option>
                                    </select>
                                </label>
                            </div>
                            
                            <div id="${journalId}-outside-radius-controls" style="display: none; margin-top: 8px;">
                                <label>Radius: 
                                    <select id="${journalId}-outside-radius-size">
                                        <option value="0.015">0.015"</option>
                                        <option value="0.030">0.030"</option>
                                        <option value="0.045">0.045"</option>
                                        <option value="0.060" selected>0.060"</option>
                                    </select>
                                </label>
                            </div>
                            
                            <h4 style="margin-top: 12px;">Threads</h4>
                            
                            <p><strong>Tapped Ends:</strong></p>
                            <div class="ios-toggle-row">
                                <span class="ios-toggle-label">Tapped Thread</span>
                                <label class="ios-toggle">
                                    <input type="checkbox" id="${journalId}-tapped-thread">
                                    <span class="ios-toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div id="${journalId}-tapped-thread-controls" style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 3px;">
                                <p><strong>Thread Type:</strong></p>
                                <select id="${journalId}-tapped-thread-type">
                                    <option value="unc">UNC (Coarse)</option>
                                    <option value="unf">UNF (Fine)</option>
                                </select>
                                <p style="margin-top: 8px;"><strong>Thread Size:</strong></p>
                                <select id="${journalId}-tapped-thread-size">
                                    <option value="1/4-20">1/4-20</option>
                                    <option value="5/16-18">5/16-18</option>
                                    <option value="3/8-16">3/8-16</option>
                                    <option value="1/2-13">1/2-13</option>
                                    <option value="5/8-11">5/8-11</option>
                                </select>
                            </div>
                            
                            <p style="margin-top: 8px;"><strong>Threaded Ends:</strong></p>
                            <div class="ios-toggle-row">
                                <span class="ios-toggle-label">Threaded End</span>
                                <label class="ios-toggle">
                                    <input type="checkbox" id="${journalId}-threaded-end">
                                    <span class="ios-toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div id="${journalId}-threaded-end-controls" style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 3px;">
                                <p><strong>Thread Type:</strong></p>
                                <select id="${journalId}-threaded-end-type">
                                    <option value="unc">UNC (Coarse)</option>
                                    <option value="unf">UNF (Fine)</option>
                                </select>
                                <p style="margin-top: 8px;"><strong>Thread Size:</strong></p>
                                <select id="${journalId}-threaded-end-size">
                                    <option value="1/4-20">1/4-20</option>
                                    <option value="5/16-18">5/16-18</option>
                                    <option value="3/8-16">3/8-16</option>
                                    <option value="1/2-13">1/2-13</option>
                                    <option value="5/8-11">5/8-11</option>
                                </select>
                            </div>
                            
                            <h4 style="margin-top: 12px;">Milled Flats</h4>
                            <p style="font-size: 12px; color: #666; font-style: italic;">Coming soon</p>
                            
                            <h4 style="margin-top: 12px;">Milled Slots</h4>
                            <p style="font-size: 12px; color: #666; font-style: italic;">Coming soon</p>
                            
                            <h4 style="margin-top: 12px;">Thru Holes</h4>
                            <p style="font-size: 12px; color: #666; font-style: italic;">Coming soon</p>
                        </div>
                        
                        <button type="button" class="remove-journal" data-journal-id="${journalId}" data-side="${side}" style="margin-top: 12px; width: 100%; background: #e74c3c; color: white; border-color: #c0392b;">
                            Remove Journal
                        </button>
                    </div>
                </details>
            `;
            
            // Add to journals array
            journals[side].push({
                id: journalId,
                element: journalHTML
            });
            
            // Insert into DOM
            const container = document.getElementById('journals-container');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = journalHTML;
            container.appendChild(tempDiv.firstElementChild);
            
            // Setup keyway toggle handler
            const keywayToggle = document.getElementById(`${journalId}-keyway`);
            const keywayControls = document.getElementById(`${journalId}-keyway-controls`);
            
            keywayToggle.addEventListener('change', function() {
                keywayControls.style.display = this.checked ? 'block' : 'none';
                if (this.checked) {
                    // Populate keyway options when first enabled
                    const diameter = parseFloat(document.getElementById(`${journalId}-diameter`).value);
                    populateKeywayOptions(`${journalId}-keyway`, diameter);
                }
                updateHeight();
            });
            
            // Setup captivated/end toggle buttons
            const captivatedButtons = document.querySelectorAll(`[data-keyway="${journalId}-keyway"]`);
            const locationControls = document.getElementById(`${journalId}-keyway-location-controls`);
            
            captivatedButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    captivatedButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const config = this.dataset.config;
                    // Show location for captivated, hide for end
                    locationControls.style.display = (config === 'captivated') ? 'block' : 'none';
                    updateHeight();
                });
            });
            
            // Setup retaining ring toggle handler
            const retainingRingToggle = document.getElementById(`${journalId}-retaining-ring`);
            const retainingRingControls = document.getElementById(`${journalId}-retaining-ring-controls`);
            
            retainingRingToggle.addEventListener('change', function() {
                retainingRingControls.style.display = this.checked ? 'block' : 'none';
                updateHeight();
            });
            
            // Setup diameter change handler
            const diameterSelect = document.getElementById(`${journalId}-diameter`);
            diameterSelect.addEventListener('change', function() {
                if (keywayToggle.checked) {
                    const diameter = parseFloat(this.value);
                    populateKeywayOptions(`${journalId}-keyway`, diameter);
                }
                
                // Update retaining ring diameter options to only show smaller than journal
                const journalDiameter = parseFloat(this.value);
                const retainingRingDiameterSelect = document.getElementById(`${journalId}-retaining-ring-diameter`);
                Array.from(retainingRingDiameterSelect.options).forEach(option => {
                    const optionValue = parseFloat(option.value);
                    option.disabled = optionValue >= journalDiameter;
                    if (option.selected && optionValue >= journalDiameter) {
                        // Auto-select first valid option
                        for (let i = 0; i < retainingRingDiameterSelect.options.length; i++) {
                            if (parseFloat(retainingRingDiameterSelect.options[i].value) < journalDiameter) {
                                retainingRingDiameterSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                });
                
                updateHeight();
            });
            
            // Setup corner condition override handlers
            const insideCornerSelect = document.getElementById(`${journalId}-inside-corner`);
            const insideChamferControls = document.getElementById(`${journalId}-inside-chamfer-controls`);
            const insideRadiusControls = document.getElementById(`${journalId}-inside-radius-controls`);
            
            if (insideCornerSelect) {
                insideCornerSelect.addEventListener('change', function() {
                    insideChamferControls.style.display = 'none';
                    insideRadiusControls.style.display = 'none';
                    if (this.value === 'chamfer') {
                        insideChamferControls.style.display = 'block';
                    } else if (this.value === 'radius') {
                        insideRadiusControls.style.display = 'block';
                    }
                    updateHeight();
                });
            }
            
            const outsideCornerSelect = document.getElementById(`${journalId}-outside-corner`);
            const outsideChamferControls = document.getElementById(`${journalId}-outside-chamfer-controls`);
            const outsideRadiusControls = document.getElementById(`${journalId}-outside-radius-controls`);
            
            if (outsideCornerSelect) {
                outsideCornerSelect.addEventListener('change', function() {
                    outsideChamferControls.style.display = 'none';
                    outsideRadiusControls.style.display = 'none';
                    if (this.value === 'chamfer') {
                        outsideChamferControls.style.display = 'block';
                    } else if (this.value === 'radius') {
                        outsideRadiusControls.style.display = 'block';
                    }
                    updateHeight();
                });
            }
            
            // Setup tapped thread toggle handler
            const tappedThreadToggle = document.getElementById(`${journalId}-tapped-thread`);
            const tappedThreadControls = document.getElementById(`${journalId}-tapped-thread-controls`);
            
            if (tappedThreadToggle) {
                tappedThreadToggle.addEventListener('change', function() {
                    tappedThreadControls.style.display = this.checked ? 'block' : 'none';
                    updateHeight();
                });
            }
            
            // Setup threaded end toggle handler
            const threadedEndToggle = document.getElementById(`${journalId}-threaded-end`);
            const threadedEndControls = document.getElementById(`${journalId}-threaded-end-controls`);
            
            if (threadedEndToggle) {
                threadedEndToggle.addEventListener('change', function() {
                    threadedEndControls.style.display = this.checked ? 'block' : 'none';
                    updateHeight();
                });
            }
            
            // Setup remove button handler
            const removeBtn = document.querySelector(`[data-journal-id="${journalId}"]`);
            removeBtn.addEventListener('click', function() {
                removeJournal(journalId, side);
            });
            
            // Show/hide initial journal buttons
            updateInitialButtons();
            
            // Update height
            updateHeight();
            
            console.log(`Created journal: ${journalId}`);
        }
            journalCounter++;
            const journalId = `journal-${side}-${journalCounter}`;
            
            const journalHTML = `
                <details open>
                    <summary>JOURNAL ${side.toUpperCase()} #${journals[side].length + 1}</summary>
                    <div>
                        <h4>Dimensions</h4>
                        <p>Diameter:</p>
                        <select id="${journalId}-diameter">
                            <option value="0.375">3/8"</option>
                            <option value="0.5">1/2"</option>
                            <option value="0.625">5/8"</option>
                            <option value="0.75" selected>3/4"</option>
                            <option value="0.875">7/8"</option>
                            <option value="1.0">1"</option>
                        </select>
                        
                        <p style="margin-top: 8px;">Length (inches):</p>
                        <input type="number" id="${journalId}-length" value="1" min="0.25" max="12" step="0.25">
                        
                        <h4 style="margin-top: 12px;">Features</h4>
                        
                        <div class="ios-toggle-row">
                            <span class="ios-toggle-label">Keyway</span>
                            <label class="ios-toggle">
                                <input type="checkbox" id="${journalId}-keyway">
                                <span class="ios-toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div id="${journalId}-keyway-controls" style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 3px;">
                            <p><strong>Configuration:</strong></p>
                            <div class="toggle-container" style="margin-bottom: 12px;">
                                <button type="button" class="toggle-option active" data-keyway="${journalId}-keyway" data-config="captivated">Captivated</button>
                                <button type="button" class="toggle-option" data-keyway="${journalId}-keyway" data-config="end">End</button>
                            </div>
                            
                            <p><strong>Keyway Size:</strong></p>
                            <select id="${journalId}-keyway-size">
                                <!-- Populated dynamically based on shaft diameter -->
                            </select>
                            
                            <p style="margin-top: 8px;"><strong>Keyway Length:</strong></p>
                            <div class="number-input-wrapper">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="adjustValue('${journalId}-keyway-length', -0.125)">-</button>
                                </div>
                                <input type="number" id="${journalId}-keyway-length" value="0.5" min="0.125" max="12" step="0.125">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="adjustValue('${journalId}-keyway-length', 0.125)">+</button>
                                </div>
                            </div>
                            
                            <div id="${journalId}-keyway-location-controls" style="display: block; margin-top: 8px;">
                                <p><strong>Location from ${side === 'left' ? 'Left' : 'Right'} End:</strong></p>
                                <div class="number-input-wrapper">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="adjustValue('${journalId}-keyway-location', -0.125)">-</button>
                                    </div>
                                    <input type="number" id="${journalId}-keyway-location" value="0.25" min="0" max="12" step="0.125">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="adjustValue('${journalId}-keyway-location', 0.125)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ios-toggle-row">
                            <span class="ios-toggle-label">Retaining Ring</span>
                            <label class="ios-toggle">
                                <input type="checkbox" id="${journalId}-retaining-ring">
                                <span class="ios-toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div id="${journalId}-retaining-ring-controls" style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 3px;">
                            <p><strong>Diameter:</strong></p>
                            <select id="${journalId}-retaining-ring-diameter">
                                <option value="0.25">1/4"</option>
                                <option value="0.375">3/8"</option>
                                <option value="0.5">1/2"</option>
                                <option value="0.625" selected>5/8"</option>
                            </select>
                            
                            <p style="margin-top: 8px;"><strong>Width:</strong></p>
                            <div class="number-input-wrapper">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="adjustValue('${journalId}-retaining-ring-width', -0.0625)">-</button>
                                </div>
                                <input type="number" id="${journalId}-retaining-ring-width" value="0.125" min="0.0625" max="1" step="0.0625">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="adjustValue('${journalId}-retaining-ring-width', 0.0625)">+</button>
                                </div>
                            </div>
                            
                            <p style="margin-top: 8px;"><strong>Location from ${side === 'left' ? 'Left' : 'Right'} End:</strong></p>
                            <div class="number-input-wrapper">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="adjustValue('${journalId}-retaining-ring-location', -0.125)">-</button>
                                </div>
                                <input type="number" id="${journalId}-retaining-ring-location" value="0.5" min="0" max="12" step="0.125">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="adjustValue('${journalId}-retaining-ring-location', 0.125)">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="advanced-features" style="display: none;">
                            <h4 style="margin-top: 12px;">Corner Condition Overrides</h4>
                            <p style="font-size: 12px; color: #666; font-style: italic;">Override global corner conditions for this journal</p>
                            
                            <h4 style="margin-top: 12px;">Threads</h4>
                            <div class="ios-toggle-row">
                                <span class="ios-toggle-label">Thread</span>
                                <label class="ios-toggle">
                                    <input type="checkbox" id="${journalId}-thread">
                                    <span class="ios-toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div id="${journalId}-thread-controls" style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 3px;">
                                <p><strong>Thread Type:</strong></p>
                                <select id="${journalId}-thread-type">
                                    <option value="unc">UNC (Coarse)</option>
                                    <option value="unf">UNF (Fine)</option>
                                </select>
                                <p style="margin-top: 8px;"><strong>Thread Size:</strong></p>
                                <select id="${journalId}-thread-size">
                                    <option value="1/4-20">1/4-20</option>
                                    <option value="5/16-18">5/16-18</option>
                                    <option value="3/8-16">3/8-16</option>
                                    <option value="1/2-13">1/2-13</option>
                                    <option value="5/8-11">5/8-11</option>
                                </select>
                            </div>
                            
                            <h4 style="margin-top: 12px;">Milled Flats</h4>
                            <p style="font-size: 12px; color: #666; font-style: italic;">Coming soon</p>
                            
                            <h4 style="margin-top: 12px;">Milled Slots</h4>
                            <p style="font-size: 12px; color: #666; font-style: italic;">Coming soon</p>
                            
                            <h4 style="margin-top: 12px;">Thru Holes</h4>
                            <p style="font-size: 12px; color: #666; font-style: italic;">Coming soon</p>
                        </div>
                        
                        <button type="button" class="remove-journal" data-journal-id="${journalId}" data-side="${side}" style="margin-top: 12px; width: 100%; background: #e74c3c; color: white; border-color: #c0392b;">
                            Remove Journal
                        </button>
                    </div>
                </details>
            `;
            
            // Add to journals array
            journals[side].push({
                id: journalId,
                element: journalHTML
            });
            
            // Insert into DOM
            const container = document.getElementById('journals-container');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = journalHTML;
            container.appendChild(tempDiv.firstElementChild);
            
            // Setup keyway toggle handler
            const keywayToggle = document.getElementById(`${journalId}-keyway`);
            const keywayControls = document.getElementById(`${journalId}-keyway-controls`);
            
            keywayToggle.addEventListener('change', function() {
                keywayControls.style.display = this.checked ? 'block' : 'none';
                if (this.checked) {
                    // Populate keyway options when first enabled
                    const diameter = parseFloat(document.getElementById(`${journalId}-diameter`).value);
                    populateKeywayOptions(`${journalId}-keyway`, diameter);
                }
                updateHeight();
            });
            
            // Setup captivated/end toggle buttons
            const captivatedButtons = document.querySelectorAll(`[data-keyway="${journalId}-keyway"]`);
            const locationControls = document.getElementById(`${journalId}-keyway-location-controls`);
            
            captivatedButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    captivatedButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const config = this.dataset.config;
                    // Show location for captivated, hide for end
                    locationControls.style.display = (config === 'captivated') ? 'block' : 'none';
                    updateHeight();
                });
            });
            
            // Setup retaining ring toggle handler
            const retainingRingToggle = document.getElementById(`${journalId}-retaining-ring`);
            const retainingRingControls = document.getElementById(`${journalId}-retaining-ring-controls`);
            
            retainingRingToggle.addEventListener('change', function() {
                retainingRingControls.style.display = this.checked ? 'block' : 'none';
                updateHeight();
            });
            
            // Setup diameter change handler
            const diameterSelect = document.getElementById(`${journalId}-diameter`);
            diameterSelect.addEventListener('change', function() {
                if (keywayToggle.checked) {
                    const diameter = parseFloat(this.value);
                    populateKeywayOptions(`${journalId}-keyway`, diameter);
                }
                
                // Update retaining ring diameter options to only show smaller than journal
                const journalDiameter = parseFloat(this.value);
                const retainingRingDiameterSelect = document.getElementById(`${journalId}-retaining-ring-diameter`);
                Array.from(retainingRingDiameterSelect.options).forEach(option => {
                    const optionValue = parseFloat(option.value);
                    option.disabled = optionValue >= journalDiameter;
                    if (option.selected && optionValue >= journalDiameter) {
                        // Auto-select first valid option
                        for (let i = 0; i < retainingRingDiameterSelect.options.length; i++) {
                            if (parseFloat(retainingRingDiameterSelect.options[i].value) < journalDiameter) {
                                retainingRingDiameterSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                });
                
                updateHeight();
            });
            
            // Setup thread toggle handler (in advanced mode section)
            const threadToggle = document.getElementById(`${journalId}-thread`);
            const threadControls = document.getElementById(`${journalId}-thread-controls`);
            
            if (threadToggle) {
                threadToggle.addEventListener('change', function() {
                    threadControls.style.display = this.checked ? 'block' : 'none';
                    updateHeight();
                });
            }
            
            // Setup remove button handler
            const removeBtn = document.querySelector(`[data-journal-id="${journalId}"]`);
            removeBtn.addEventListener('click', function() {
                removeJournal(journalId, side);
            });
            
            // Show/hide initial journal buttons
            updateInitialButtons();
            
            // Update height
            updateHeight();
            
            console.log(`Created journal: ${journalId}`);
        }
        
        function removeJournal(journalId, side) {
            // Find and remove from array
            const index = journals[side].findIndex(j => j.id === journalId);
            if (index > -1) {
                journals[side].splice(index, 1);
            }
            
            // Remove from DOM
            const detailsElement = document.querySelector(`[data-journal-id="${journalId}"]`).closest('details');
            detailsElement.remove();
            
            // Renumber remaining journals
            renumberJournals(side);
            
            // Show/hide initial journal buttons
            updateInitialButtons();
            
            // Update height
            updateHeight();
            
            console.log(`Removed journal: ${journalId}`);
        }
        
        function renumberJournals(side) {
            const journalElements = document.querySelectorAll(`details summary`);
            let counter = 1;
            
            journalElements.forEach(summary => {
                const text = summary.textContent;
                if (text.includes(`JOURNAL ${side.toUpperCase()}`)) {
                    summary.textContent = `JOURNAL ${side.toUpperCase()} #${counter}`;
                    counter++;
                }
            });
        }
        
        function updateInitialButtons() {
            const initialButtons = document.getElementById('initial-journal-buttons');
            const hasAnyJournals = journals.left.length > 0 || journals.right.length > 0;
            
            // Hide initial buttons if any journals exist, show if none exist
            initialButtons.style.display = hasAnyJournals ? 'none' : 'flex';
        }

        // ===========================================
        // BUTTON CLICK HANDLERS
        // ===========================================
        document.querySelectorAll('.add-journal-left').forEach(btn => {
            btn.addEventListener('click', function() {
                createJournal('left');
            });
        });
        
        document.querySelectorAll('.add-journal-right').forEach(btn => {
            btn.addEventListener('click', function() {
                createJournal('right');
            });
        });

        // ===========================================
        // CORNER CONDITION HANDLERS
        // ===========================================
        document.querySelectorAll('input[name="global-inside"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('global-inside-chamfer-controls').style.display = 'none';
                document.getElementById('global-inside-radius-controls').style.display = 'none';
                
                if (this.value === 'chamfer') {
                    document.getElementById('global-inside-chamfer-controls').style.display = 'block';
                } else if (this.value === 'radius') {
                    document.getElementById('global-inside-radius-controls').style.display = 'block';
                }
                updateHeight();
            });
        });
        
        document.querySelectorAll('input[name="global-outside"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('global-outside-chamfer-controls').style.display = 'none';
                document.getElementById('global-outside-radius-controls').style.display = 'none';
                
                if (this.value === 'chamfer') {
                    document.getElementById('global-outside-chamfer-controls').style.display = 'block';
                } else if (this.value === 'radius') {
                    document.getElementById('global-outside-radius-controls').style.display = 'block';
                }
                updateHeight();
            });
        });

        // ===========================================
        // HEIGHT UPDATE SYSTEM
        // ===========================================
        function updateHeight() {
            const height = document.documentElement.scrollHeight;
            window.parent.postMessage({type: 'resize', height: height}, '*');
        }

        // Update height on various events
        window.addEventListener('load', updateHeight);
        window.addEventListener('resize', updateHeight);
        
        // Watch for DOM changes
        const observer = new MutationObserver(updateHeight);
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true
        });
        
        // Update height when details elements open/close
        document.querySelectorAll('details').forEach(details => {
            details.addEventListener('toggle', updateHeight);
        });
        
        console.log('Shaft Configurator loaded - Standalone version for iframe');
        console.log('Features: TG&P material restrictions, dynamic journal creation');
    </script>
</body>
</html>
